<!DOCTYPE html>
<html lang="en" class="no-js" ng-app="myApp">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Zappos|Shoes, Clothing Online</title>
		<meta name="description" content="Zappos Application for Discount Notification" />
		<meta name="keywords" content="Zappos, Application, Shoes, Clothing" />
		<meta name="author" content="Sarim" />
		<link rel="shortcut icon" href="../favicon.ico">
		<link rel="stylesheet" type="text/css" href="css/default.css" />
		<link rel="stylesheet" type="text/css" href="css/component.css" />
		
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular.min.js"></script>
		<script src="js/modernizr.custom.js"></script>
		<script type="text/javascript" src="tinybox.js"></script>
		<!-- Make sure my AngularJS calls our API as a "GET", rather than as an "OPTION"-->
		<script>
			var query = window.location.search;
			// Skip the leading ?, which should always be there,
			// but be careful anyway
			if (query.substring(0, 1) == '?') {
				query = query.substring(1);
			}
			var data = query.split(',');

			var searchterm = data[0];
			var categoryname = data[1];
		
			var myApp = angular.module('myApp', []);
			myApp.config(['$httpProvider',
			function($httpProvider) {

				$httpProvider.defaults.useXDomain = true;
				delete $httpProvider.defaults.headers.common['X-Requested-With'];
			}]);

			// my function to populate the product details
			myApp.filter('orderObjectBy', function() {
				return function(items, field, reverse) {
					var filtered = [];
					angular.forEach(items, function(item, key) {
						item["key"] = key;
						filtered.push(item);
					});
					filtered.sort(function (a, b) {
						return (a[field] > b[field]) ? 1 : ((a[field] < b[field]) ? -1 : 0);
					});
					if(reverse) filtered.reverse();
					return filtered;
				};
			});
			function AngularController($scope, $http) {

				
				$scope.searchItem = null;

				
				$scope.listOfProducts = null;

				$scope.loadProducts = function() {
					$http.jsonp('http://api.zappos.com/Search/term/'+searchterm+'?callback=JSON_CALLBACK&limit=30&includes=["categoryFacet"]&filters={"categoryFacet":["'+categoryname+'"]}&key=12c3302e49b9b40ab8a222d7cf79a69ad11ffd78').success(function(data) {
						var txt = data;
						var obj = eval(txt);
						for (var i=0;i<obj.results.length;i++) {
							obj.results[i].pricevalue = parseInt(obj.results[i].price.replace(/\$/, ""));
						}
						$scope.listOfProducts = obj.results;
					}).error(function(data, status, headers, config) {
						$scope.errorMessage = "No product matching this search found, error # " + status;
						alert($scope.errorMessage);
					});
				};

				//redirecting to product url
				$scope.redirecting = function(url) {
					
					window.open(url, '_blank');
				};
				
				//redirecting to form
				$scope.popup = function(productId, styleId) {
					window.location = 'form.html?' + productId + ',' + styleId;
				};
				
				$scope.showprod = function(pid) {
					TINY.box.show({iframe:'popup.html?'+pid,boxid:'frameless',width:750,height:450,fixed:false,maskid:'blackmask',maskopacity:40,closejs:function(){closeJS()}});
				}

			}
		</script>
	</head>
	<body ng-controller="AngularController" ng-model="searchItem" ng-init="loadProducts()">
		<div data-role="page">
		<div id="cbp-pgcontainer" class="cbp-pgcontainer">
		<ul class="cbp-pggrid">
			<li ng-repeat="product in listOfProducts | orderObjectBy:'pricevalue':true">
				<div class="cbp-pgcontent"  ng-click="showprod(product.productId)">

					<div class="cbp-pgitem">
						<div class="cbp-pgitem-flip">
							<img src={{product.thumbnailImageUrl}} /> </img><!--add image here-->

						</div>
					</div><!-- /cbp-pgitem -->
					<ul class="cbp-pgoptions">

						<li class="cbp-pgoptfav">
							<!--setup an onclick for opening a form popup-->
							Favorite
						</li>

						
						<li class="cbp-pgoptcart" ng-click="redirecting(product.productUrl)" ></li>
					</ul><!-- cbp-pgoptions -->
				</div><!-- cbp-pgcontent -->
				<div class="cbp-pginfo">
					<h3>{{product.productName}}</h3><!--product name-->
					<!--<h3>{{product.brandName}}</h3><!--brandname->-->
					<span class="cbp-pgprice">{{product.price}}</span><!--product price-->
				</div>
			</li>

		</ul><!-- /cbp-pggrid -->
			</div><!-- /cbp-pgcontainer -->

		</div><!-- /content -->

		</div><!---page ends-->

		<script src="js/cbpShop.min.js"></script>
		<script>
			var shop = new cbpShop(document.getElementById('cbp-pgcontainer'));
		</script>
	</body>
</html>